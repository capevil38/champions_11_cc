<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Players – Champions 11 CC</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="container">
        <a class="navbar-brand" href="index.html">Champions 11 CC</a>
        <ul class="navbar-nav">
          <li><a href="index.html">Home</a></li>
          <li><a href="players.html" class="active">Players</a></li>
          <li><a href="matches.html">Matches</a></li>
          <li><a href="leaderboards.html">Leaderboards</a></li>
          <li><a href="awards.html">Awards</a></li>
          <li><a href="admin.html">Upload</a></li>
        </ul>
      </div>
    </nav>

    <main class="container">
      <div class="section-heading">
        <h2>Players</h2>
        <span>Career snapshots & roles</span>
      </div>
      <div style="margin-bottom:1rem;">
        <input type="text" id="playerSearch" class="input-control" placeholder="Search players..." />
      </div>
      <div class="filter-row">
        <div>
          <label for="playerOpponentFilter">Opponent Filter</label>
          <select id="playerOpponentFilter" class="input-control">
            <option value="">All Opponents</option>
          </select>
        </div>
        <div>
          <label for="playerVenueFilter">Venue Filter</label>
          <select id="playerVenueFilter" class="input-control">
            <option value="">All Venues</option>
          </select>
        </div>
      </div>
      <details class="stat-section" open>
        <summary>Batting</summary>
        <div class="table-responsive">
          <table id="battingTable">
            <thead>
              <tr>
                <th data-field="name">Name</th>
                <th data-field="role">Role</th>
                <th data-field="matches">Matches</th>
                <th data-field="innings">Innings</th>
                <th data-field="runs">Runs</th>
                <th data-field="balls">Balls</th>
                <th data-field="fours">Fours</th>
                <th data-field="sixes">Sixes</th>
                <th data-field="avg">Avg</th>
                <th data-field="sr">SR</th>
              </tr>
            </thead>
            <tbody id="battingBody"></tbody>
          </table>
        </div>
      </details>

      <details class="stat-section" open>
        <summary>Bowling</summary>
        <div class="table-responsive">
          <table id="bowlingTable">
            <thead>
              <tr>
                <th data-field="name">Name</th>
                <th data-field="overs">Overs</th>
                <th data-field="wkts">Wkts</th>
                <th data-field="runs">Runs</th>
                <th data-field="econ">Econ</th>
                <th data-field="maidens">Maidens</th>
                <th data-field="dots">Dot Balls</th>
                <th data-field="foursconceded">4s Given</th>
                <th data-field="sixesconceded">6s Given</th>
                <th data-field="wides">Wides</th>
                <th data-field="noballs">No-Balls</th>
              </tr>
            </thead>
            <tbody id="bowlingBody"></tbody>
          </table>
        </div>
      </details>

      <details class="stat-section" open>
        <summary>Fielding</summary>
        <div class="table-responsive">
          <table id="fieldingTable">
            <thead>
              <tr>
                <th data-field="name">Name</th>
                <th data-field="matches">Matches</th>
                <th data-field="catches">Catches</th>
                <th data-field="runouts">Run Outs</th>
                <th data-field="stumpings">Stumpings</th>
              </tr>
            </thead>
            <tbody id="fieldingBody"></tbody>
          </table>
        </div>
      </details>

      <div class="section-heading">
        <h2>Player Comparison</h2>
        <span>Head-to-head metrics</span>
      </div>
      <div class="card comparison-card">
        <div class="comparison-controls">
          <select id="playerASelect" class="input-control"></select>
          <select id="playerBSelect" class="input-control"></select>
        </div>
        <div class="grid grid-2" id="comparisonResults"></div>
      </div>
    </main>
    <footer>
      © <span id="year"></span> Champions 11 CC
    </footer>
    <script src="script.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const data = await loadData();
        const searchInput = document.getElementById('playerSearch');
        const opponentFilter = document.getElementById('playerOpponentFilter');
        const venueFilter = document.getElementById('playerVenueFilter');
        const comparisonSelectA = document.getElementById('playerASelect');
        const comparisonSelectB = document.getElementById('playerBSelect');
        const comparisonResults = document.getElementById('comparisonResults');
        const matchIndex = Analytics.buildPlayerMatchIndex(data);
        matchIndex.opponents.forEach((opp) => {
          const option = document.createElement('option');
          option.value = opp;
          option.textContent = opp;
          opponentFilter.appendChild(option);
        });
        matchIndex.venues.forEach((venue) => {
          const option = document.createElement('option');
          option.value = venue;
          option.textContent = venue;
          venueFilter.appendChild(option);
        });
        data.players.forEach((player, idx) => {
          [comparisonSelectA, comparisonSelectB].forEach((select) => {
            const option = document.createElement('option');
            option.value = player['PlayerID'];
            option.textContent = player['Player Name'];
            select.appendChild(option);
          });
        });
        if (data.players.length >= 2) {
          comparisonSelectA.value = data.players[0]['PlayerID'];
          comparisonSelectB.value = data.players[1]['PlayerID'];
        }
        const playerFilterState = {
          opponent: '',
          venue: '',
        };
        const formatDecimal = (value) =>
          value != null ? parseFloat(value).toFixed(2) : '-';
        const hasValue = (val) =>
          !(
            val === null ||
            val === undefined ||
            val === '' ||
            val === '-'
          );
        const hasBattingData = (stat) =>
          ['Runs', 'Balls', 'Fours', 'Sixes', 'Avg', 'SR'].some((field) =>
            hasValue(stat[field])
          );
        const hasBowlingData = (stat) =>
          [
            'Wkts',
            'Overs',
            'Econ',
            'Maidens',
            'Dot Balls',
            'Bowl Runs',
            'Fours Conceded',
            'Sixes Conceded',
            'Wides',
            'No-Balls',
          ].some((field) => hasValue(stat[field]));
        const hasFieldingData = (stat) =>
          ['Catches', 'Run Outs', 'Stumpings'].some((field) =>
            hasValue(stat[field])
          );
        const sections = {
          batting: {
            tbody: document.getElementById('battingBody'),
            headers: document.querySelectorAll('#battingTable th'),
            sortField: '',
            ascending: true,
            filterFn: hasBattingData,
            getValue: (stat, field) => {
              const player = getPlayerById(data, stat['PlayerID']);
              switch (field) {
                case 'name':
                  return player ? player['Player Name'].toLowerCase() : '';
                case 'role':
                  return player && player['Role']
                    ? player['Role'].toLowerCase()
                    : '';
                case 'matches':
                  return stat.Matches || 0;
                case 'innings':
                  return stat.Innings || 0;
                case 'runs':
                  return stat.Runs || 0;
                case 'balls':
                  return stat.Balls || 0;
                case 'fours':
                  return stat.Fours || 0;
                case 'sixes':
                  return stat.Sixes || 0;
                case 'avg':
                  return stat.Avg || 0;
                case 'sr':
                  return stat.SR || 0;
                default:
                  return 0;
              }
            },
            buildRow: (stat, player) => `
              <td><a href="player.html?id=${stat['PlayerID']}">${player['Player Name']}</a></td>
              <td>${player['Role'] || '-'}</td>
              <td>${formatNumber(stat.Matches)}</td>
              <td>${formatNumber(stat.Innings)}</td>
              <td>${formatNumber(stat.Runs)}</td>
              <td>${formatNumber(stat.Balls)}</td>
              <td>${formatNumber(stat.Fours)}</td>
              <td>${formatNumber(stat.Sixes)}</td>
              <td>${formatDecimal(stat.Avg)}</td>
              <td>${formatDecimal(stat.SR)}</td>
            `,
          },
          bowling: {
            tbody: document.getElementById('bowlingBody'),
            headers: document.querySelectorAll('#bowlingTable th'),
            sortField: '',
            ascending: true,
            filterFn: hasBowlingData,
            getValue: (stat, field) => {
              const player = getPlayerById(data, stat['PlayerID']);
              switch (field) {
                case 'name':
                  return player ? player['Player Name'].toLowerCase() : '';
                case 'overs':
                  return stat.Overs != null ? parseFloat(stat.Overs) : 0;
                case 'wkts':
                  return stat.Wkts || 0;
                case 'runs':
                  return stat['Bowl Runs'] || 0;
                case 'econ':
                  return stat.Econ || 0;
                case 'maidens':
                  return stat.Maidens || 0;
                case 'dots':
                  return stat['Dot Balls'] || 0;
                case 'foursconceded':
                  return stat['Fours Conceded'] || 0;
                case 'sixesconceded':
                  return stat['Sixes Conceded'] || 0;
                case 'wides':
                  return stat.Wides || 0;
                case 'noballs':
                  return stat['No-Balls'] || 0;
                default:
                  return 0;
              }
            },
            buildRow: (stat, player) => `
              <td><a href="player.html?id=${stat['PlayerID']}">${player['Player Name']}</a></td>
              <td>${stat.Overs != null ? stat.Overs : '-'}</td>
              <td>${formatNumber(stat.Wkts)}</td>
              <td>${formatNumber(stat['Bowl Runs'])}</td>
              <td>${formatDecimal(stat.Econ)}</td>
              <td>${formatNumber(stat.Maidens)}</td>
              <td>${formatNumber(stat['Dot Balls'])}</td>
              <td>${formatNumber(stat['Fours Conceded'])}</td>
              <td>${formatNumber(stat['Sixes Conceded'])}</td>
              <td>${formatNumber(stat.Wides)}</td>
              <td>${formatNumber(stat['No-Balls'])}</td>
            `,
          },
          fielding: {
            tbody: document.getElementById('fieldingBody'),
            headers: document.querySelectorAll('#fieldingTable th'),
            sortField: '',
            ascending: true,
            filterFn: hasFieldingData,
            getValue: (stat, field) => {
              const player = getPlayerById(data, stat['PlayerID']);
              switch (field) {
                case 'name':
                  return player ? player['Player Name'].toLowerCase() : '';
                case 'matches':
                  return stat.Matches || 0;
                case 'catches':
                  return stat.Catches || 0;
                case 'runouts':
                  return stat['Run Outs'] || 0;
                case 'stumpings':
                  return stat.Stumpings || 0;
                default:
                  return 0;
              }
            },
            buildRow: (stat, player) => `
              <td><a href="player.html?id=${stat['PlayerID']}">${player['Player Name']}</a></td>
              <td>${formatNumber(stat.Matches)}</td>
              <td>${formatNumber(stat.Catches)}</td>
              <td>${formatNumber(stat['Run Outs'])}</td>
              <td>${formatNumber(stat.Stumpings)}</td>
            `,
          },
        };
        function sortSection(list, section) {
          if (!section.sortField) return list.slice();
          return list.slice().sort((a, b) => {
            const aVal = section.getValue(a, section.sortField);
            const bVal = section.getValue(b, section.sortField);
            if (typeof aVal === 'string' || typeof bVal === 'string') {
              const aStr = (aVal || '').toString();
              const bStr = (bVal || '').toString();
              return section.ascending
                ? aStr.localeCompare(bStr)
                : bStr.localeCompare(aStr);
            }
            return section.ascending ? aVal - bVal : bVal - aVal;
          });
        }
        function renderSection(section, list) {
          section.tbody.innerHTML = '';
          list.forEach((stat) => {
            const player = getPlayerById(data, stat['PlayerID']);
            if (!player) return;
            const tr = document.createElement('tr');
            tr.innerHTML = section.buildRow(stat, player);
            section.tbody.appendChild(tr);
          });
        }
        function matchesFilters(stat) {
          if (playerFilterState.opponent) {
            const set = matchIndex.playerOpponents[stat['PlayerID']];
            if (!set || !set.has(playerFilterState.opponent)) return false;
          }
          if (playerFilterState.venue) {
            const set = matchIndex.playerVenues[stat['PlayerID']];
            if (!set || !set.has(playerFilterState.venue)) return false;
          }
          return true;
        }
        function updateTables() {
          const filtered = filterPlayers(data, searchInput.value).filter(matchesFilters);
          Object.values(sections).forEach((section) => {
            const baseList = section.filterFn
              ? filtered.filter(section.filterFn)
              : filtered.slice();
            const rows = sortSection(baseList, section);
            renderSection(section, rows);
          });
        }
        Object.values(sections).forEach((section) => {
          section.headers.forEach((th) => {
            const field = th.getAttribute('data-field');
            th.addEventListener('click', () => {
              if (section.sortField === field) {
                section.ascending = !section.ascending;
              } else {
                section.sortField = field;
                section.ascending = true;
              }
              updateTables();
            });
          });
        });
        searchInput.addEventListener('input', updateTables);
        opponentFilter.addEventListener('change', () => {
          playerFilterState.opponent = opponentFilter.value;
          updateTables();
        });
        venueFilter.addEventListener('change', () => {
          playerFilterState.venue = venueFilter.value;
          updateTables();
        });
        updateTables();
        function buildComparisonCard(info) {
          if (!info || !info.player || !info.career) {
            return `<div class="card">No data</div>`;
          }
          const { player, career, recentBatting, recentBowling } = info;
          const battingSummary = recentBatting
            .map((entry) => `${entry.MatchID}: ${formatNumber(entry.Runs)} runs`)
            .join('<br />') || 'No recent batting records';
          const bowlingSummary = recentBowling
            .map((entry) => `${entry.MatchID}: ${formatNumber(entry.Wkts)} wkts`)
            .join('<br />') || 'No recent bowling records';
          return `
            <div class="card">
              <h3>${player['Player Name']}</h3>
              <div class="stat-grid">
                <div class="stat-pill"><span>Matches</span>${formatNumber(career.Matches)}</div>
                <div class="stat-pill"><span>Runs</span>${formatNumber(career.Runs)}</div>
                <div class="stat-pill"><span>Bat Avg</span>${formatDecimal(career.Avg)}</div>
                <div class="stat-pill"><span>Strike Rate</span>${formatDecimal(career.SR)}</div>
                <div class="stat-pill"><span>Wickets</span>${formatNumber(career.Wkts)}</div>
                <div class="stat-pill"><span>Economy</span>${formatDecimal(career.Econ)}</div>
              </div>
              <div class="muted-text"><strong>Recent Batting:</strong><br />${battingSummary}</div>
              <div class="muted-text" style="margin-top:0.5rem;"><strong>Recent Bowling:</strong><br />${bowlingSummary}</div>
            </div>
          `;
        }
        function renderComparison() {
          const statsA = Analytics.getPlayerComparisonStats(data, comparisonSelectA.value);
          const statsB = Analytics.getPlayerComparisonStats(data, comparisonSelectB.value);
          comparisonResults.innerHTML = [statsA, statsB].map((info) => buildComparisonCard(info)).join('');
        }
        comparisonSelectA.addEventListener('change', renderComparison);
        comparisonSelectB.addEventListener('change', renderComparison);
        renderComparison();
        document.getElementById('year').textContent = new Date().getFullYear();
      });
    </script>
  </body>
</html>
